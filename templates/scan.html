{% extends "base.html" %}

{% block content %}
<h2>Scan Attendance QR Code</h2>

<div class="row">
    {# Scanner & Form Column #}
    <div class="col-md-7">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5>Scan QR Code</h5>
            </div>
            <div class="card-body">
                {# --- FORM containing both Event Selection and QR Reader --- #}
                <form id="attendance-form" method="POST" action="{{ url_for('scan') }}">
                    
                    {# --- Event Selection Dropdown --- #}
                    <div class="mb-3">
                        <label for="event-select" class="form-label"><strong>Select Active Event:</strong> <span class="text-danger">*</span></label>
                        <select class="form-select" id="event-select" name="active_event_id" required>
                            <option value="" selected disabled>-- Please choose an event --</option>
                            {# Populate options from events passed by app.py #}
                            {% for event in events %}
                                <option value="{{ event['event_id'] }}">{{ event['name'] }} ({{ event['event_date'] }})</option>
                            {% endfor %}
                        </select>
                         {# Display message if no events exist #}
                         {% if not events %}
                             <div class="alert alert-warning mt-2">No events found. Please create an event first via "Manage Events".</div>
                         {% endif %}
                    </div>
                    {# --- End Event Selection --- #}

                    {# Hidden input for the scanned student ID #}
                    <input type="hidden" name="student_id" id="student-id-input">

                    {# QR Code Reader Area #}
                    <div class="mb-3">
                         <label class="form-label"><strong>Scan QR Code Below:</strong></label>
                         {# Disable scanning if no events are available #}
                        <div id="qr-reader" style="width: 100%; border: 1px solid #ccc; {% if not events %}opacity: 0.5; pointer-events: none;{% endif %}"></div>
                        <div id="qr-reader-results" class="mt-2"></div> {# Optional: display decoded text #}
                    </div>

                    {# Submit button (optional, JS submits automatically) #}
                    {# <button type="submit" class="btn btn-primary">Submit Manually (if needed)</button> #}
                    
                </form>
                 {# --- END FORM --- #}
            </div>
        </div>
    </div>

    {# Instructions Column #}
    <div class="col-md-5">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5>Instructions</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Select the current event</strong> from the dropdown menu.</li>
                    <li>Allow camera access if prompted.</li>
                    <li>Position the student's QR code in front of the camera.</li>
                    <li>Attendance will be automatically submitted upon successful scan.</li>
                    <li>Check for success/error messages at the top of the page after scan.</li>
                </ol>
                <div class="alert alert-info mt-3">
                    Note: Attendance is recorded only if the student is registered for the selected event and hasn't already scanned for it today.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# Only load/run scanner JS if events exist #}
{% if events %} 
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script> {# Use a specific version #}
<script>
    function onScanSuccess(decodedText, decodedResult) {
        // Handle the scanned code:
        console.log(`Code matched = ${decodedText}`, decodedResult);

        // Find the form and the hidden input
        const form = document.getElementById('attendance-form');
        const studentIdInput = document.getElementById('student-id-input');
        const eventSelect = document.getElementById('event-select');
        
        // Optional: Add visual feedback
        const resultsDiv = document.getElementById('qr-reader-results');
        if(resultsDiv) {
           resultsDiv.innerHTML = `<span class="text-success">Scanned: ${decodedText}. Submitting...</span>`;
        }

        // Check if an event is selected
        if (!eventSelect.value) {
             if(resultsDiv) {
                 resultsDiv.innerHTML = `<span class="text-danger">ERROR: Please select an event before scanning!</span>`;
             } else {
                 alert("ERROR: Please select an event before scanning!");
             }
             // Optionally stop the scanner here if needed, or just prevent submission
             // html5QrCode.stop(); 
             return; // Stop processing
        }

        // Populate the hidden student ID field
        if (studentIdInput) {
            studentIdInput.value = decodedText;
        } else {
            console.error("Student ID input field not found!");
            return; // Stop if field is missing
        }

        // Submit the form (which now includes selected event_id and student_id)
        if (form) {
            form.submit();
        } else {
            console.error("Attendance form not found!");
        }
    }

    function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // console.warn(`Code scan error = ${error}`);
    }

    // Ensure the qr-reader div exists before initializing
    const qrReaderElement = document.getElementById("qr-reader");
    if (qrReaderElement) {
        const html5QrCode = new Html5Qrcode("qr-reader");
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 }, // Recommended way to define qrbox
            // Remember to ask for permissions first using Html5Qrcode.getCameras()
            // if you want a camera selection feature.
            // This example uses the default environment-facing camera directly.
        };

        // Start scanning.
        html5QrCode.start(
            { facingMode: "environment" }, // Or { deviceId: { exact: camera arriÃ¨re ID } }
            config,
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            console.error("Unable to start scanning.", err);
            const resultsDiv = document.getElementById('qr-reader-results');
             if(resultsDiv) {
                 resultsDiv.innerHTML = `<span class="text-danger">ERROR: Could not start camera. ${err}</span>`;
             }
        });
    } else {
         console.error("QR Reader element not found in the DOM.");
    }

</script>
{% endif %} {# End check for events #}
{% endblock %}